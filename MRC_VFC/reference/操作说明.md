# 操作说明

本文档记录当前项目的运行方式与消融实验命令，并对应到代码结构。所有命令默认在项目根目录执行。

## 0. 基础流程（原始 MRC-VFC）

### 对应代码架构
- Stage1: `stage1.py` + `train.py` + `models/backbones.py` + `data/transforms.py`
- Stage2: `stage2.py` + `data/feature_rebalancing.py` + `utils/metrics.py`
- 配置: `config/configs.yaml`

### 运行命令
```
python stage1.py
python stage2.py
```

### Debug + 本地日志
```
python stage1.py --debug --log_file stage1.log
python stage2.py --debug --log_file stage2.log
```

## 1. 第一步改动：Stage1 类条件高斯约束（Gaussian Prior）

### 对应代码架构
- 新增损失: `utils/loss.py` -> `GaussianPriorLoss`
- Stage1 训练: `train.py` 中加入 `gaussian_prior_loss`
- 配置: `config/configs.yaml` 中 `gaussian_*` 参数

### 运行命令（保持原流程）
```
python stage1.py
python stage2.py
```

### Debug + 本地日志
```
python stage1.py --debug | tee stage1.log
python stage2.py --debug --log_file stage2.log
```

## 2. 第二步改动：Stage1 增加辅助 VAE 分支（AuxVAE，消融可选）

### 对应代码架构
- 新增模块: `models/aux_vae.py`
- Stage1 训练接入: `train.py`（`aux recon/kl loss`）
- Stage1 构建: `stage1.py`（可选创建 `AuxVAE`）
- 配置: `config/configs.yaml` 中 `use_aux_vae` 及相关参数

### 运行命令（原始基线，不启用 AuxVAE）
```
python stage1.py
python stage2.py
```

### 运行命令（启用 AuxVAE）
```
python stage1.py --use_aux_vae True
python stage2.py
```

### Debug + 本地日志（启用 AuxVAE）
```
python stage1.py --debug --use_aux_vae True --log_file stage1.log
python stage2.py --debug --log_file stage2.log
```

## 5. 运行命名与独立 checkpoint

### 对应代码架构
- `config/configs.yaml` -> `run_name`
- `stage1.py` / `stage2.py` 自动拼接 `checkpoints/<run_name>`

### 运行说明
- 默认：不传 `run_name` 会自动使用时间戳生成独立目录。
- 手动指定：传 `--run_name <name>`，会保存到 `checkpoints/<name>/`。

### 示例
```
# 自动时间戳
python stage1.py
python stage2.py

# 指定 run_name
python stage1.py --run_name exp_auxvae_001
python stage2.py --run_name exp_auxvae_001
```

## 3. 自动串联 Stage1 -> Stage2（可选）

### 对应代码架构
- `stage1.py` 中 `--auto_run_stage2`、`--stage2_debug`、`--stage2_log`

### 运行命令
```
python stage1.py --auto_run_stage2
```

### Debug + 双日志
```
python stage1.py --debug --log_file stage1.log --auto_run_stage2 --stage2_debug --stage2_log stage2.log
```

## 4. 不平衡因子对标（ISIC2019LT）

### 对应代码架构
- `config/configs.yaml` -> `imbalance_factor`
- `prepare_datasets/ISIC2019LT/split.py` 自动构建长尾分割

### 运行说明
每个 `imbalance_factor` 都需要重新训练 Stage1 + Stage2。

示例（Factor=100）：
```
# 修改 config/configs.yaml 中 imbalance_factor: 100
python stage1.py
python stage2.py
```
